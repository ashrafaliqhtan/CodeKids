<?php
session_start();
include('./dbConnection.php');

// Handle form toggling
$show_signup = isset($_GET['show_signup']) ? true : false;

// Handle Student Login
if(isset($_POST['stuLogEmail']) && isset($_POST['stuLogPass'])) {
    $stuLogEmail = $_POST['stuLogEmail'];
    $stuLogPass = $_POST['stuLogPass'];
    
    $sql = "SELECT stu_email, stu_pass FROM students WHERE stu_email='".$stuLogEmail."'";
    $result = $conn->query($sql);
    
    if($result->num_rows == 1) {
        $row = $result->fetch_assoc();
        if(password_verify($stuLogPass, $row['stu_pass'])) {
            $_SESSION['is_login'] = true;
            $_SESSION['stuLogEmail'] = $stuLogEmail;
            header('Location: myCourses.php');
            exit();
        } else {
            $login_error = "Invalid Email or Password";
        }
    } else {
        $login_error = "Invalid Email or Password";
    }
}

// Handle Student Signup
if(isset($_POST['stuname']) && isset($_POST['stuemail']) && isset($_POST['stupass'])) {
    $stuname = $_POST['stuname'];
    $stuemail = $_POST['stuemail'];
    $stupass = password_hash($_POST['stupass'], PASSWORD_BCRYPT);
    
    // Check if email exists
    $check_sql = "SELECT stu_email FROM students WHERE stu_email='".$stuemail."'";
    $check_result = $conn->query($check_sql);
    
    if($check_result->num_rows > 0) {
        $signup_error = "Email already registered!";
        $show_signup = true;
    } else {
        $insert_sql = "INSERT INTO students(stu_name, stu_email, stu_pass) VALUES('$stuname', '$stuemail', '$stupass')";
        if($conn->query($insert_sql)) {
            $_SESSION['is_login'] = true;
            $_SESSION['stuLogEmail'] = $stuemail;
            header('Location: myCourses.php');
            exit();
        } else {
            $signup_error = "Registration failed: " . $conn->error;
            $show_signup = true;
        }
    }
}
?><!DOCTYPE html><html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.0/css/line.css" />
    <link rel="shortcut icon" type="image/png" href="images/logo.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src='https://kit.fontawesome.com/a076d05399.js' crossorigin='anonymous'></script>
    <link rel="stylesheet" href="css/style.css" />
    <title>CodeKids | Authentication</title>
</head>
<body>
    <!-- Navbar -->
    <nav>
        <div class="container nav_container">
            <a class="home_button" href="index.php"><h3>ðŸŽ® CodeKids</h3></a>
            <ul class="nav_menu">
                <?php if(!isset($_SESSION['is_login'])): ?>
                    <li><a href="index.php?show_signup=true"><i class="uil uil-user-plus"></i> Join Now</a></li>
                    <li><a href="index.php"><i class="uil uil-signin"></i> Login</a></li>
                <?php endif; ?>
            </ul>
        </div>
    </nav><!-- Header -->
<header>
    <div class="header_content">
        <div class="header_text-box">
            <h1 class="heading-primary">
                <span class="heading-primary--main">Welcome to CodeKids</span>
                <span class="heading-primary--sub">Please Login or Sign Up to Continue</span>
            </h1>
        </div>
    </div>
</header>

<!-- Authentication Overlay -->
<div id="explore" class="overlay" style="display:block">
    <div class="wrapper">
        <a href="#" class="close" onclick="window.location='index.php'; return false;">&times;</a>
        <div class="column details">
            <?php if(!$show_signup && !isset($signup_error)): ?>
            <!-- Login Form -->
            <div class="signin">
                <h2 class="stu-form-header">Student Sign In</h2>
                <form method="POST" action="index.php">
                    <input type="email" placeholder="Email" name="stuLogEmail" required value="<?= isset(\$_POST['stuLogEmail']) ? htmlspecialchars(\$_POST['stuLogEmail']) : '' ?>"/>
                    <input type="password" placeholder="Password" name="stuLogPass" required />
                    <?php if(isset($login_error)): ?><small style="color:red; margin-bottom:.3rem"><?= \$login_error ?></small><?php endif; ?>
                    <button type="submit" class="form-submit">Log In</button>
                </form>
                <span class="form-span">Don't have an account? <a href="index.php?show_signup=true" class="toggle-form">Sign Up</a></span>
            </div>
            <?php else: ?>
            <!-- Signup Form -->
            <div class="signup">
                <h2 class="stu-form-header">Student Sign Up</h2>
                <form method="POST" action="index.php">
                    <input type="text" placeholder="Full Name" name="stuname" required value="<?= isset(\$_POST['stuname']) ? htmlspecialchars(\$_POST['stuname']) : '' ?>"/>
                    <input type="email" placeholder="Email" name="stuemail" required value="<?= isset(\$_POST['stuemail']) ? htmlspecialchars(\$_POST['stuemail']) : '' ?>"/>
                    <input type="password" placeholder="Password" name="stupass" required />
                    <?php if(isset($signup_error)): ?><small style="color:red; margin-bottom:.3rem"><?= \$signup_error ?></small><?php endif; ?>
                    <button type="submit" class="form-submit">Sign Up</button>
                </form>
                <span class="form-span">Already have an account? <a href="index.php" class="toggle-form">Sign In</a></span>
            </div>
            <?php endif; ?>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
<script>
    // Ensure overlay stays visible
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('explore').style.display = 'block';
    });
</script>

</body>
</html>