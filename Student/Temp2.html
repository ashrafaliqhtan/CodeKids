<?php
// Start session (same as your other pages)
if(!isset($_SESSION)){
  session_start();
}
include_once('../dbConnection.php');

if(isset($_SESSION['is_login'])){
  $stuEmail=$_SESSION['stuLogEmail'];
}else{
  echo "<script>location.href='../index.php' </script>";
}

if(isset($_SESSION['is_login'])){
    $stuLogEmail=$_SESSION['stuLogEmail'];
  }
  if(isset($stuLogEmail)){
    $sql="SELECT * FROM students WHERE stu_email = '$stuLogEmail'";
    $result=$conn->query($sql);
    $row=$result->fetch_assoc();
    $stu_img=$row['stu_img'];
    $stuId=$row['stu_id'];
    $stuName=$row['stu_name'];
    $stuOcc=$row['stu_occ'];
  }

$stuLogEmail = $_SESSION['stuLogEmail'];
$user_id = (int)$_SESSION['stu_id'];

$user_id1 = (int)$_SESSION['game_id'];



$game_id = (int)$_GET['game_id'];

// Check if user has access to this game (updated to match your schema)
$sql = "SELECT lg.*, l.lesson_name, l.lesson_id, l.course_id 
        FROM lesson_games lg
        JOIN lesson l ON lg.lesson_id = l.lesson_id
        JOIN course c ON l.course_id = c.course_id
        WHERE lg.game_id = ?";
$stmt = $conn->prepare($sql);
$stmt->bind_param("i", $game_id);
$stmt->execute();
$result = $stmt->get_result();

$game = $result->fetch_assoc();
$questions = json_decode($game['questions'], true);

// Validate JSON data


// Check if questions exist
$total_questions = 0;
$valid_question_types = ['true_false', 'multiple_choice', 'multi_select'];

foreach ($valid_question_types as $type) {
    if (isset($questions[$type]) && is_array($questions[$type])) {
        $total_questions += count($questions[$type]);
    }
}



// Check if user already completed this game
$stmt = $conn->prepare("SELECT score FROM user_game_progress WHERE stu_id = ? AND game_id = ?");
$stmt->bind_param("ii", $stuId, $game_id);
$stmt->execute();
$completed_result = $stmt->get_result();
$completed = $completed_result->num_rows > 0;
$previous_score = $completed ? $completed_result->fetch_assoc()['score'] : null;

// Set secure headers
header("Content-Security-Policy: default-src 'self'; script-src 'self' https://cdnjs.cloudflare.com 'unsafe-inline'; style-src 'self' https://cdnjs.cloudflare.com https://fonts.googleapis.com 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https://cdnjs.cloudflare.com https://fonts.gstatic.com; frame-src 'self'; connect-src 'self'");
header("X-Frame-Options: DENY");
header("X-Content-Type-Options: nosniff");
header("Referrer-Policy: strict-origin-when-cross-origin");
?>







<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?php echo htmlspecialchars($game['lesson_name']); ?> Game | CodeKids</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #6C63FF;
            --secondary-color: #4A42D6;
            --accent-color: #FF6584;
            --success-color: #4CAF50;
            --warning-color: #FFC107;
            --danger-color: #F44336;
            --light-bg: #F8F9FA;
            --dark-text: #2D3748;
            --light-text: #F7FAFC;
            --border-radius: 12px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light-bg);
            color: var(--dark-text);
            line-height: 1.6;
            padding: 0;
            margin: 0;
        }
        
        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
        }
        
        .game-title {
            color: var(--primary-color);
            font-size: 2rem;
        }
        
        .back-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .back-btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: var(--box-shadow);
        }
        
        /* Progress bar styles */
        .progress-container {
            margin-bottom: 30px;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .progress-bar {
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        /* Game content styles */
        .game-content {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--box-shadow);
            position: relative;
        }
        
        /* Character and speech bubble */
        .character-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .speech-bubble {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            border-radius: 20px;
            margin-bottom: 15px;
            max-width: 80%;
            position: relative;
            text-align: center;
            animation: bounce 2s infinite;
        }
        
        .speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 10px 10px 0;
            border-style: solid;
            border-color: var(--primary-color) transparent transparent;
        }
        
        .character {
            max-width: 150px;
            height: auto;
            transition: all 0.3s ease;
        }
        
        /* Question section */
        .question-section {
            margin-bottom: 30px;
        }
        
        .question-text {
            font-size: 1.3rem;
            margin-bottom: 20px;
            font-weight: 600;
            color: var(--dark-text);
        }
        
        .options-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .option {
            padding: 15px;
            border-radius: var(--border-radius);
            border: 2px solid #e0e0e0;
            background-color: white;
            cursor: pointer;
            transition: var(--transition);
            text-align: left;
            font-size: 1rem;
        }
        
        .option:hover {
            border-color: var(--primary-color);
            transform: translateY(-3px);
            box-shadow: var(--box-shadow);
        }
        
        .true-btn {
            background-color: rgba(76, 175, 80, 0.1);
            border-color: var(--success-color);
        }
        
        .false-btn {
            background-color: rgba(244, 67, 54, 0.1);
            border-color: var(--danger-color);
        }
        
        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            border-radius: var(--border-radius);
            border: 2px solid #e0e0e0;
            background-color: white;
            cursor: pointer;
        }
        
        .checkbox-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .submit-btn {
            grid-column: 1 / -1;
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: var(--transition);
            margin-top: 15px;
        }
        
        .submit-btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: var(--box-shadow);
        }
        
        /* Feedback styles */
        .feedback {
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            font-weight: bold;
            text-align: center;
            display: none;
        }
        
        .feedback.correct {
            background-color: rgba(76, 175, 80, 0.2);
            color: var(--success-color);
            border: 1px solid var(--success-color);
            display: block;
        }
        
        .feedback.wrong {
            background-color: rgba(244, 67, 54, 0.2);
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
            display: block;
        }
        
        /* Help button */
        .help-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background-color: var(--warning-color);
            color: var(--dark-text);
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: var(--box-shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: var(--transition);
            z-index: 100;
        }
        
        .help-btn:hover {
            transform: scale(1.1);
        }
        
        /* Result screen */
        .result-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
            padding: 20px;
        }
        
        .result-screen.show {
            opacity: 1;
            pointer-events: all;
        }
        
        .result-content {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 40px;
            max-width: 600px;
            width: 100%;
            text-align: center;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .result-title {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 2rem;
        }
        
        .score-display {
            font-size: 3rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 20px 0;
        }
        
        .stars {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        
        .star {
            font-size: 2.5rem;
            color: #e0e0e0;
        }
        
        .star.filled {
            color: var(--warning-color);
            animation: starFill 0.5s ease forwards;
        }
        
        .result-message {
            margin: 20px 0;
            font-size: 1.1rem;
            line-height: 1.6;
        }
        
        .next-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: var(--transition);
            margin-top: 20px;
        }
        
        .next-btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: var(--box-shadow);
        }
        
        /* Confetti effect */
        .confetti {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
            opacity: 0;
            transition: opacity 1s ease;
        }
        
        /* Animations */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes starFill {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .game-container {
                padding: 15px;
            }
            
            .game-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .question-text {
                font-size: 1.1rem;
            }
            
            .result-content {
                padding: 20px;
            }
            
            .result-title {
                font-size: 1.5rem;
            }
            
            .score-display {
                font-size: 2rem;
            }
            
            .star {
                font-size: 1.8rem;
            }
        }
        
        /* Accessibility focus styles */
        button:focus, .option:focus, input:focus {
            outline: 3px solid var(--primary-color);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <h1 class="game-title"><?php echo htmlspecialchars($game['lesson_name']); ?> Game</h1>
            <button class="back-btn" onclick="window.location.href='watchCourse.php?lesson_id=<?php echo (int)$game['lesson_id']; ?>'">
                <i class="fas fa-arrow-left"></i> Back to Lesson
            </button>
        </div>
        
        <div class="progress-container">
            <div class="progress-text">
                <span id="progressText">Question 1/<?php echo $total_questions; ?></span>
                <span id="scoreText">Score: 0</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
        
        <div class="game-content">
            <div class="character-container">
                <div class="speech-bubble" id="hintBubble">Ready to play? Let's go!</div>
                <img src="../images/character-normal.png" alt="Game Character" class="character" id="characterImg">
            </div>
            
            <div class="question-section" id="questionSection">
                <div class="question-text" id="questionText"></div>
                <div class="options-container" id="optionsContainer"></div>
                <div class="feedback" id="feedback"></div>
            </div>
            
            <button class="help-btn" id="helpBtn" aria-label="Get hint">
                <i class="fas fa-lightbulb"></i>
            </button>
            
            <div class="confetti" id="confetti"></div>
            
            <div class="result-screen" id="resultScreen">
                <div class="result-content">
                    <h2 class="result-title">Game Completed!</h2>
                    <div class="score-display" id="finalScore">0%</div>
                    <div class="stars" id="starsContainer"></div>
                    <p class="result-message" id="resultMessage"></p>
                    <button class="next-btn" id="nextBtn">Continue Learning</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game data from PHP with proper escaping
        const gameData = {
            questions: <?php echo json_encode($questions, JSON_HEX_TAG | JSON_HEX_APOS | JSON_HEX_QUOT | JSON_HEX_AMP); ?>,
            passingScore: <?php echo (int)$game['passing_score']; ?>,
            totalQuestions: <?php echo $total_questions; ?>,
            gameId: <?php echo $game_id; ?>,
            userId: <?php echo $stuId; ?>,
            lessonId: <?php echo (int)$game['lesson_id']; ?>,
            completed: <?php echo $completed ? 'true' : 'false'; ?>,
            previousScore: <?php echo $previous_score !== null ? (int)$previous_score : 'null'; ?>,
            lessonName: <?php echo json_encode($game['lesson_name'], JSON_HEX_TAG | JSON_HEX_APOS | JSON_HEX_QUOT | JSON_HEX_AMP); ?>
        };
        
    
        
        
        // Game state
        let gameState = {
            currentSection: 'true_false',
            currentQuestion: 0,
            score: 0,
            hintsUsed: 0,
            currentHint: 0,
            answeredQuestions: 0
        };
        
        // DOM elements
        const questionText = document.getElementById('questionText');
        const optionsContainer = document.getElementById('optionsContainer');
        const feedback = document.getElementById('feedback');
        const progressText = document.getElementById('progressText');
        const scoreText = document.getElementById('scoreText');
        const progressFill = document.getElementById('progressFill');
        const hintBubble = document.getElementById('hintBubble');
        const characterImg = document.getElementById('characterImg');
        const helpBtn = document.getElementById('helpBtn');
        const resultScreen = document.getElementById('resultScreen');
        const finalScore = document.getElementById('finalScore');
        const starsContainer = document.getElementById('starsContainer');
        const resultMessage = document.getElementById('resultMessage');
        const nextBtn = document.getElementById('nextBtn');
        const confetti = document.getElementById('confetti');
        
        // Initialize game
        document.addEventListener('DOMContentLoaded', function() {
            // Check if already completed
            if (gameData.completed) {
                showResult(gameData.previousScore, true);
            } else {
                loadQuestion();
                updateProgress();
            }
            
            // Set up event listeners
            helpBtn.addEventListener('click', showHint);
            nextBtn.addEventListener('click', proceedAfterGame);
            
            // Accessibility - make options keyboard navigable
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && document.activeElement.classList.contains('option')) {
                    document.activeElement.click();
                }
            });
        });
        
        // Load current question
        function loadQuestion() {
            // Clear previous question
            optionsContainer.innerHTML = '';
            feedback.innerHTML = '';
            feedback.className = 'feedback';
            gameState.currentHint = 0;
            
            // Get current question
            const question = gameData.questions[gameState.currentSection][gameState.currentQuestion];
            
            // Set question text
            questionText.textContent = question.question;
            
            // Create appropriate options based on question type
            if (gameState.currentSection === 'true_false') {
                const trueBtn = document.createElement('button');
                trueBtn.className = 'option true-btn';
                trueBtn.textContent = 'True';
                trueBtn.onclick = () => checkAnswer(true);
                trueBtn.tabIndex = 0;
                
                const falseBtn = document.createElement('button');
                falseBtn.className = 'option false-btn';
                falseBtn.textContent = 'False';
                falseBtn.onclick = () => checkAnswer(false);
                falseBtn.tabIndex = 0;
                
                optionsContainer.append(trueBtn, falseBtn);
            } 
            else if (gameState.currentSection === 'multiple_choice') {
                question.options.forEach((option, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'option';
                    btn.textContent = option;
                    btn.onclick = () => checkAnswer(index);
                    btn.tabIndex = 0;
                    optionsContainer.appendChild(btn);
                });
            }
            else if (gameState.currentSection === 'multi_select') {
                question.options.forEach((option, index) => {
                    const label = document.createElement('label');
                    label.className = 'option checkbox-option';
                    label.innerHTML = `
                        <input type="checkbox" value="${index}" tabindex="0">
                        <span>${option}</span>
                    `;
                    optionsContainer.appendChild(label);
                });
                
                const submitBtn = document.createElement('button');
                submitBtn.className = 'submit-btn';
                submitBtn.textContent = 'Submit Answers';
                submitBtn.onclick = checkMultiSelectAnswer;
                submitBtn.tabIndex = 0;
                optionsContainer.appendChild(submitBtn);
            }
            
            // Update character
            updateCharacter('normal');
            speak("Can you answer this question?");
        }
        
        // Check answer for true/false and multiple choice
        function checkAnswer(userAnswer) {
            const question = gameData.questions[gameState.currentSection][gameState.currentQuestion];
            const options = document.querySelectorAll('.option');
            let isCorrect = false;
            
            // Disable all options
            options.forEach(opt => {
                opt.style.pointerEvents = 'none';
                opt.tabIndex = -1;
            });
            
            // Check answer
            if (gameState.currentSection === 'true_false') {
                isCorrect = userAnswer === question.correctAnswer;
            } 
            else if (gameState.currentSection === 'multiple_choice') {
                isCorrect = userAnswer === question.correctIndex;
            }
            
            // Highlight correct/wrong answers
            if (isCorrect) {
                highlightCorrectAnswer(userAnswer);
                gameState.score++;
                updateCharacter('happy');
                speak("Great job! That's correct!");
                showFeedback("Correct! Well done!", true);
            } else {
                highlightWrongAnswer(userAnswer, 
                    gameState.currentSection === 'true_false' ? !userAnswer : question.correctIndex);
                updateCharacter('confused');
                speak("Oops! That's not quite right.");
                showFeedback("Not quite! The correct answer is highlighted.", false);
            }
            
            gameState.answeredQuestions++;
            
            // Update score and progress
            updateProgress();
            
            // Move to next question after delay
            setTimeout(nextQuestion, 2000);
        }
        
        // Check multi-select answers
        function checkMultiSelectAnswer() {
            const question = gameData.questions[gameState.currentSection][gameState.currentQuestion];
            const selected = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
                                .map(el => parseInt(el.value));
            
            const isCorrect = selected.length === question.correctIndices.length &&
                              question.correctIndices.every(i => selected.includes(i));
            
            // Disable all options
            document.querySelectorAll('.option').forEach(opt => {
                opt.style.pointerEvents = 'none';
                const inputs = opt.querySelectorAll('input');
                if (inputs) {
                    inputs.forEach(input => input.disabled = true);
                }
            });
            
            if (isCorrect) {
                gameState.score++;
                updateCharacter('happy');
                speak("Excellent! All correct answers!");
                showFeedback("Perfect! You got them all!", true);
                highlightCorrectAnswers(question.correctIndices);
            } else {
                updateCharacter('confused');
                speak("Almost! Some answers are missing.");
                showFeedback("Some answers are incorrect. The correct ones are highlighted.", false);
                highlightCorrectAnswers(question.correctIndices);
            }
            
            gameState.answeredQuestions++;
            
            // Update score and progress
            updateProgress();
            
            // Move to next question after delay
            setTimeout(nextQuestion, 2000);
        }
        
        // Move to next question
        function nextQuestion() {
            gameState.currentQuestion++;
            gameState.hintsUsed = 0;
            
            // Check if we need to move to next section
            if (gameState.currentQuestion >= gameData.questions[gameState.currentSection].length) {
                if (gameState.currentSection === 'true_false') {
                    gameState.currentSection = 'multiple_choice';
                } else if (gameState.currentSection === 'multiple_choice') {
                    gameState.currentSection = 'multi_select';
                } else {
                    finishGame();
                    return;
                }
                gameState.currentQuestion = 0;
            }
            
            loadQuestion();
            updateProgress();
        }
        
        // Finish the game
        function finishGame() {
            const scorePercentage = Math.round((gameState.score / gameData.totalQuestions) * 100);
            showResult(scorePercentage);
        }
        
        // Show final result
        function showResult(scorePercentage, alreadyCompleted = false) {
            finalScore.textContent = `${scorePercentage}%`;
            
            // Calculate stars (1-3)
            const stars = Math.min(3, Math.ceil(scorePercentage / 33));
            starsContainer.innerHTML = '';
            
            for (let i = 0; i < stars; i++) {
                const star = document.createElement('i');
                star.className = 'fas fa-star star';
                star.style.animationDelay = `${i * 0.2}s`;
                starsContainer.appendChild(star);
                
                // Animate star filling
                setTimeout(() => {
                    star.classList.add('filled');
                }, i * 200);
            }
            
            if (scorePercentage >= gameData.passingScore) {
                resultMessage.textContent = alreadyCompleted ? 
                    "You already completed this game with a great score!" :
                    "Congratulations! You passed the game!";
                
                // Show confetti if just completed
                if (!alreadyCompleted) {
                    confetti.style.opacity = '1';
                    createConfetti();
                    setTimeout(() => confetti.style.opacity = '0', 3000);
                }
            } else {
                resultMessage.textContent = alreadyCompleted ?
                    "You completed this game but didn't pass. Try again!" :
                    "Good try! Practice more and try again to pass!";
            }
            
            // Show result screen
            resultScreen.classList.add('show');
            
            // Focus on the result screen for accessibility
            resultScreen.focus();
        }
        
        // Create confetti effect
        function createConfetti() {
            const colors = ['#6C63FF', '#FF6584', '#FFC107', '#4CAF50', '#2196F3'];
            
            for (let i = 0; i < 100; i++) {
                const confettiPiece = document.createElement('div');
                confettiPiece.style.position = 'absolute';
                confettiPiece.style.width = '10px';
                confettiPiece.style.height = '10px';
                confettiPiece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confettiPiece.style.left = Math.random() * 100 + 'vw';
                confettiPiece.style.top = '-10px';
                confettiPiece.style.opacity = Math.random();
                confettiPiece.style.transform = `rotate(${Math.random() * 360}deg)`;
                confettiPiece.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                
                const animationDuration = Math.random() * 3 + 2;
                confettiPiece.style.animation = `fall ${animationDuration}s linear forwards`;
                
                confetti.appendChild(confettiPiece);
                
                // Remove confetti piece after animation
                setTimeout(() => {
                    confettiPiece.remove();
                }, animationDuration * 1000);
            }
            
            // Add CSS for animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fall {
                    to {
                        transform: translateY(100vh) rotate(360deg);
                    }
                }
            `;
            document.head.appendChild(style);
        }
        
        // Proceed after game completion
        function proceedAfterGame() {
            const scorePercentage = Math.round((gameState.score / gameData.totalQuestions) * 100);
            
            if (!gameData.completed && scorePercentage >= gameData.passingScore) {
                saveGameResult(scorePercentage);
            }
            
            window.location.href = `watchCourse.php?lesson_id=${gameData.lessonId}`;
        }
        
        // Save game result to server
        function saveGameResult(score) {
            fetch('../save_game_result.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': gameData.csrfToken
                },
                body: JSON.stringify({
                    stu_id: gameData.userId,
                    game_id: gameData.gameId,
                    score: score,
                    lesson_id: gameData.lessonId,
                    csrf_token: gameData.csrfToken
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (!data.success) {
                    console.error('Error saving game result:', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
        
        // Show hint for current question
        function showHint() {
            if (gameState.hintsUsed >= 2) {
                speak("No more hints for this question!");
                return;
            }
            
            const question = gameData.questions[gameState.currentSection][gameState.currentQuestion];
            let hint = "";
            
            if (gameState.hintsUsed === 0) {
                hint = question.hint || question.hint1 || "Think carefully about the question";
            } else {
                hint = question.hint2 || "Try eliminating obviously wrong options first";
            }
            
            speak(hint);
            gameState.hintsUsed++;
        }
        
        // Helper functions
        function highlightCorrectAnswer(index) {
            const options = document.querySelectorAll('.option');
            if (gameState.currentSection === 'true_false') {
                options[index ? 0 : 1].classList.add('correct');
            } else {
                options[index].classList.add('correct');
            }
        }
        
        function highlightWrongAnswer(userIndex, correctIndex) {
            const options = document.querySelectorAll('.option');
            options[userIndex].classList.add('wrong');
            
            if (correctIndex !== undefined) {
                if (gameState.currentSection === 'true_false') {
                    options[correctIndex ? 0 : 1].classList.add('correct');
                } else {
                    options[correctIndex].classList.add('correct');
                }
            }
        }
        
        function highlightCorrectAnswers(correctIndices) {
            const options = document.querySelectorAll('.checkbox-option');
            options.forEach((opt, idx) => {
                if (correctIndices.includes(idx)) {
                    opt.classList.add('correct');
                }
            });
        }
        
        function showFeedback(message, isCorrect) {
            feedback.textContent = message;
            feedback.classList.add(isCorrect ? 'correct' : 'wrong');
        }
        
        function updateProgress() {
            const progress = (gameState.answeredQuestions / gameData.totalQuestions) * 100;
            
            progressText.textContent = `Question ${gameState.answeredQuestions}/${gameData.totalQuestions}`;
            scoreText.textContent = `Score: ${gameState.score}/${gameData.totalQuestions}`;
            progressFill.style.width = `${progress}%`;
        }
        
        function updateCharacter(mood) {
            characterImg.src = `../images/character-${mood}.png`;
        }
        
        function speak(text) {
            hintBubble.textContent = text;
            // Reset animation
            hintBubble.style.animation = 'none';
            void hintBubble.offsetWidth; // Trigger reflow
            hintBubble.style.animation = 'bounce 2s infinite';
        }
        
        // Accessibility - make sure all interactive elements are keyboard accessible
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && resultScreen.classList.contains('show')) {
                proceedAfterGame();
            }
        });













        
        // ... rest of your JavaScript ...
    </script>
</body>
</html>